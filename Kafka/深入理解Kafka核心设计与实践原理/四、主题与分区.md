主题作为消息的归类，可以再细分为一个或多个分区，分区也可以看作对消息的二次归类。

分区的划分不仅为Kafka提供了可伸缩性、水平扩展的功能，还通过多副本机制来为Kafka提供数据冗余以提高数据可靠性。

主题和分区都是逻辑上的概念，分区可以有一至多个副本，每个副本对应一个日志文件，每个日志文件对应一至多个日志分段（LogSegment），每个日志分段还可以细分为索引文件、日志存储文件和快照文件等。

## 一、主题的管理

主题的管理包括创建主题、查看主题信息、修改主题和删除主题等操作。

可以通过 Kafka提供的 [kafka-topics.sh](https://link.zhihu.com/?target=http%3A//kafka-topics.sh) 脚本来执行这些操作。实质上是调用了kafka.admin.TopicCommand类来执行主题管理的操作。主题的管理还可以通过KafkaAdminClient 的方式实现，甚至还可以通过直接操纵日志文件和ZooKeeper节点来实现。

### 4.1.1 创建主题

如果broker端配置参数auto.create.topics.enable设置为true（默认值就是true），那么当生产者向一个尚未创建的主题发送消息时，会自动创建一个分区数为num.partitions （默认值为1）、副本因子为default.replication.factor（默认值为1）的主题。

### 4.1.2 分区副本的分配

生产者的分区分配是指为每条消息指定其所要发往的分区，消费者中的分区分配是指为消费者指定其可以消费消息的分区，而这里的分区分配是指为集群制定创建主题时的分区副本分配方案，即在哪个broker中创建哪些分区的副本。

使用kafka-topics.sh脚本创建主题时的内部分配逻辑按照机架信息划分成两种策略：未指定机架信息和指定机架信息。

当创建一个主题时，无论通过kafka-topics.sh脚本，还是通过其他方式（比如4.2节中介绍的KafkaAdminClient）创建主题时，实质上是在ZooKeeper中的/brokers/topics节点下创建与该主题对应的子节点并写入分区副本分配方案，并且在/config/topics/节点下创建与该主题对应的子节点并写入主题相关的配置信息（这个步骤可以省略不执行）。而Kafka创建主题的实质性动作是交由控制器异步去完成的。

### 4.1.3 查看主题

kafka-topics.sh脚本有5种指令类型：create、list、describe、alter和delete。其中list和describe指令可以用来方便地查看主题信息。

### 4.1.4 修改主题

当一个主题被创建之后，依然允许我们对其做一定的修改，比如修改分区个数、修改配置等，这个修改的功能就是由kafka-topics.sh脚本中的alter指令提供的。

目前Kafka只支持增加分区数而不支持减少分区数。

### 4.1.5 配置管理

[kafka-configs.sh](https://link.zhihu.com/?target=http%3A//kafka-configs.sh) 脚本是专门用来对配置进行操作的，这里的操作是指在运行状态下修改原有的配置，如此可以达到动态变更的目的。

### 4.1.6 主题端参数

### 4.1.7 删除主题

## 4.2 初识KafkaAdminClient

KafkaAdminClient不仅可以用来管理broker、配置和ACL（Access ControlList），还可以用来管理主题。

KafkaAdminClient继承了org.apache.kafka.clients.admin.AdminClient抽象类，并提供了多种方法，例如：

- 创建主题：CreateTopicsResult createTopics（Collection＜NewTopic＞newTopics）。
- 删除主题：DeleteTopicsResult deleteTopics（Collection＜String＞topics）。
- 列出所有可用的主题：ListTopicsResult listTopics（）。
- 查看主题的信息：DescribeTopicsResult describeTopics（Collection＜String＞topicNames）。
- 查询配置信息：DescribeConfigsResult describeConfigs（Collection＜ConfigResource＞resources）。
- 修改配置信息：AlterConfigsResult alterConfigs（Map＜ConfigResource，Config＞configs）。
- 增加分区：CreatePartitionsResult createPartitions（Map＜String，NewPartitions＞newPartitions）。

## 4.3 分区的管理

### 4.3.1 优先副本的选举

针对同一个分区而言，同一个broker节点中不可能出现它的多个副本，即Kafka集群的一个broker中最多只能有它的一个副本，将leader副本所在的broker节点叫作分区的leader节点，而follower副本所在的broker节点叫作分区的follower节点。

当分区的leader节点发生故障时，其中一个follower节点就会成为新的leader节点，这样就会导致集群的负载不均衡，从而影响整体的健壮性和稳定性。当原来的leader节点恢复之后重新加入集群时，它只能成为一个新的follower节点而不再对外提供服务。

为了能够有效地治理负载失衡的情况，Kafka引入了**优先副本**（preferred replica）的概念。所谓的优先副本是指在 AR 集合列表中的第一个副本。

**优先副本的选举**是指通过一定的方式促使优先副本选举为leader副本，以此来促进集群的负载均衡，这一行为也可以称为“**分区平衡**”。

在 Kafka 中可以提供分区自动平衡的功能，与此对应的 broker 端参数是auto.leader.rebalance.enable，此参数的默认值为true，即默认情况下此功能是开启的。

如果开启分区自动平衡的功能，则 Kafka 的控制器会启动一个定时任务，这个定时任务会轮询所有的 broker节点，计算每个broker节点的分区不平衡率（broker中的不平衡率=非优先副本的leader个数/分区总数）是否超过leader.imbalance.per.broker.percentage参数配置的比值，默认值为 10%，如果超过设定的比值则会自动执行优先副本的选举动作以求分区平衡。

优先副本的选举过程是一个安全的过程，Kafka客户端可以自动感知分区leader副本的变更。

### 4.3.2 分区重分配

当集群中的一个节点突然宕机下线时，如果节点上的分区是单副本的，那么这些分区就变得不可用了，在节点恢复前，相应的数据也就处于丢失状态；如果节点上的分区是多副本的，那么位于这个节点上的leader副本的角色会转交到集群的其他follower副本中。总而言之，这个节点上的分区副本都已经处于功能失效的状态，Kafka 并不会将这些失效的分区副本自动地迁移到集群中剩余的可用broker节点上，如果放任不管，则不仅会影响整个集群的均衡负载，还会影响整体服务的可用性和可靠性。此时需要分区重分配。

分区重分配的基本原理是先通过控制器为每个分区添加新副本（增加副本因子），新的副本将从分区的leader副本那里复制所有的数据。在复制完成之后，控制器将旧副本从副本清单里移除（恢复为原先的副本因子数）。

### 4.3.3 复制限流

分区重分配本质在于数据复制，先增加新的副本，然后进行数据同步，最后删除旧的副本来达到最终的目的。数据复制会占用额外的资源，如果重分配的量太大必然会严重影响整体的性能，尤其是处于业务高峰期的时候。可以对副本间的复制流量加以限制来保证重分配期间整体服务不会受太大的影响。

副本间的复制限流有两种实现方式：kafka-config.sh脚本和kafka-reassign-partitions.sh脚本。

### 4.3.4 修改副本因子

与修改分区数不同的是，副本数可以减少。这个其实很好理解，最直接的方式是关闭一些broker，不过这种手法不太正规。

## 4.4 如何选择合适的分区数

Kafka 本身提供的用于生产者性能测试的 [kafka-producer-perf-test.sh和用于消费者性能测试的kafka-consumer-perf-test.sh](https://link.zhihu.com/?target=http%3A//kafka-producer-perf-test.sh%E5%92%8C%E7%94%A8%E4%BA%8E%E6%B6%88%E8%B4%B9%E8%80%85%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E7%9A%84kafka-consumer-perf-test.sh)。

如何选择合适的分区数？从某种意思来说，考验的是决策者的实战经验，更透彻地说，是对Kafka本身、业务应用、硬件资源、环境配置等多方面的考量而做出的选择。一般情况下，根据预估的吞吐量及是否与key相关的规则来设定分区数即可，后期可以通过增加分区数、增加broker或分区重分配等手段来进行改进。如果一定要给一个准则，则建议将分区数设定为集群中broker的倍数，即假定集群中有3个broker节点，可以设定分区数为3、6、9等，至于倍数的选定可以参考预估的吞吐量。